# 页面白屏如何排查

**白屏含义**: 页面未能正常渲染，导致浏览器显示一片空白，通常由浏览器渲染流水线断裂导致。

## 通用排查流程图

![流程图](/白屏调试.png)

## 常见问题

- 排查兼容性。大部分原因是因为低端机型/浏览器低版本 polyfill 的问题导致报错
- 排查网络。js 是否下载成功 cdn 是否生效
- 做 js 错误上报。分析是否存在代码缺陷
- 做重试逻辑/诱导用户重试
- Error Boundry 避免整页崩溃。限制在组件级别

## 白屏检测

> 如何设计一个白屏检测系统 SDK 呢？当宿主前端项目白屏时检测到并能上报

从前边的白屏排查流程图上，我们可以看到白屏通常有这几种情况反映在**浏览器 DOM 数据结构或者控制台**上:

- `<html><body></body></html>`: body 元素内没有 DOM 元素。通常由于 HTML 加载失败或者 head 中的 script 阻塞性错误
- `<body><div id="app"></div></body>`通常是`React/Vue`的根节点存在，但挂载后续步骤也就是后续 JS 错误，导致`mount`阶段报错
- 资源加载失败的控制台报错
- DOM 正常但是 CSS 的 `opactity`属性 等导致视图不可见

**检测方案**

基于上边的多个白屏逻辑，我们可以结合多种策略判断是否出现白屏，

1. DOM 元素采样

   - 关键元素采样:

     - 浏览器 DOMContentLoaded 生命周期时，注册一个三五秒后的回调函数（加载冗余）去取页面 id 为的 root 或 app 根元素判断是否有子元素

     - ```javascript
       const root = document.querySelector('#app'); if (root && root.children.length === 0) { ... }
       ```

   - 视窗采样

     - 在视窗上均匀取几个点，检查当前样点坐标的顶层元素

     - ```javascript
       const points = [
         /* ... 9个 (x,y) 坐标 ... */
       ];
       let emptyCount = 0;
       for (const [x, y] of points) {
         const el = document.elementFromPoint(x, y);
         const tagName = el ? el.tagName.toUpperCase() : "";
         // 如果元素是 body 或 html，说明这个点是“空的”
         if (tagName === "BODY" || tagName === "HTML") {
           emptyCount++;
         }
       }

       // 如果超过 90% 的点都是空的，判定为白屏
       if (emptyCount / points.length >= 0.9) {
         reportWhiteScreen();
       }
       ```

2. 异常事件监听

   - ```javascript
     window.addEventListener('error', (event) => { ... }, true)
     // 捕获异常，可以通过event.target判断是否是script这类资源加载出错，接着可以在两三秒后使用DOM元素采样，提升识别准确率
     ```

在细节上，还要注意

- SDK 必须在`<head>`里前置解析，以捕获所有错误
- 上报方法可以选择`navigator.sendBeacon()`,这里不详细说

## 参考资料

- ## https://juejin.cn/post/7494167764916256803
