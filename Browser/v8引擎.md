# V8 引擎

## 是什么

V8 是 Google 开发的高性能 JavaScript 引擎，使用 C++ 编写，广泛应用于 Chrome、Node.js、Electron 等运行时。其核心目标是：将动态的 JavaScript 高效地在 CPU 上执行。

## 总体架构（简化）

- Parser：词法/语法分析，生成 AST；
- Ignition（解释器）：将 AST 编译为字节码并解释执行；
- TurboFan（优化编译器）：基于运行时反馈生成优化后的机器码；
- IC（Inline Cache）：为属性访问等热点操作建立缓存；
- 隐藏类（Hidden Classes）与对象形状：加速属性定位；
- 垃圾回收（Orinoco）：分代 + 并行/并发 GC，减少停顿。

## 执行流程（概览）

1. 源码 → 词法/语法分析 → AST；
2. AST → Ignition 编译为字节码并开始解释执行；
3. 收集类型/形状等反馈，形成热点；
4. 将热点字节码投喂 TurboFan，生成优化机器码；
5. 若假设失效（类型变化等），触发去优化（deopt），回退到字节码解释。

## 性能关键机制

- Inline Cache（IC）：
  - 单态（monomorphic）、多态（polymorphic）、超多态（megamorphic）缓存形态；
  - 稳定的对象形状与一致的访问路径能让 IC 保持单态/多态，利于优化；
- 隐藏类与属性迁移：
  - 按固定顺序添加属性会形成稳定的隐藏类链，减少形状分裂；
- Escape Analysis / Inlining / 堆栈分配（优化阶段择机应用）。

## 垃圾回收（GC）

- 分代假说：新生代对象存活率低，采用 Scavenge（复制）算法；
- 老生代：标记-清除、标记-压缩，配合并行/并发减少停顿；
- 增量/并发标记：配合写屏障与三色标记，降低 STW 时间；
- 常见触发：分配失败、达到阈值、显式触发（调试场景）。

## 与浏览器/Node 的关系

- 浏览器：V8 负责 JS 执行与内存管理，结合 Blink（渲染）与网络栈实现完整能力；
- Node.js：以 V8 为内核，结合 libuv、模块系统与 API 暴露服务端能力；
- 不同宿主提供不同内建对象/全局 API，V8 专注于语言层执行与优化。

## 开发者优化建议（实践向）

- 保持对象形状稳定：在构造函数内一次性初始化属性，避免运行时增删；
- 热路径避免 megamorphic：相同位置访问相似形状对象；
- 避免稀疏数组与跨类型元素：有利于元素种类保持单态；
- 谨慎使用 `try/catch` 包裹热路径；
- 逐步优化：先定位瓶颈（Performance/Profiler），再做针对性修改；
- 长生命周期对象注意分配与释放，减少老生代压力。

## 术语对照

- AST：抽象语法树；
- 字节码：Ignition 的中间表示；
- 优化/去优化：TurboFan 产物与回退；
- IC：内联缓存；
- 隐藏类/对象形状：对象结构的内部描述；
- STW：Stop-The-World，GC 停顿。

—— 本文为基础认知与实践指北，更多实现细节可参考 V8 官方博客与源码注释。
