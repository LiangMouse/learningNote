# 登录鉴权

关键字: BA鉴权、SSO、Session、Cookie

### Session+Cookie

**概述**: Session作为会话的id存到Cookie中进行客户端服务端的互信

**流程**

1. **用户登录**：
   - 用户通过SSO（单点登录）或普通登录方式向应用程序提供用户名和密码。
   - 应用程序与服务器进行身份验证，验证成功后，服务器创建一个Session来存储用户的会话信息。
2. **生成和发送Session ID**：
   - 服务器生成一个唯一的Session ID，并将其存储在服务器端的会话存储中（例如内存、数据库等）。
   - 服务器通过响应头中的`Set-Cookie`属性将Session ID发送回客户端浏览器。
3. **存储Cookie**：
   - 客户端浏览器自动存储服务器发送的Cookie。其中包含Session ID。
   - Cookie通常会设置一些属性，比如`HttpOnly`、`Secure`等，以提高安全性。
4. **后续请求**：
   - 客户端发送后续请求时，浏览器会自动将存储的Cookie包含在请求头中。
   - 服务器通过检索Session ID，从服务器端的会话存储中查找对应的会话信息来验证用户身份。

通过Session+Cookie方案，服务器保持会话状态，每一个请求都会使用Cookie中的Session ID来确认用户身份。相比JWT，它需要服务器端保存会话信息，同时保证Cookie的安全性，比如使用SSL/TLS以防止Cookie被窃取。

### JWT(JSON web token)

**概述**: server生成token,本地不会存储，直接在response中返回，token会放到请求头中。当server收到会进行解析判断出是哪种用户

**流程**: 
1. **用户登录**：
   - 用户通过SSO（单点登录）或普通登录方式向应用程序提供用户名和密码。
   - 应用程序与服务器进行身份验证。验证成功后，服务器创建一个JWT，其中包含用户的身份信息和其他必要的声明（claims）。

2. **生成和发送JWT**：
   - 服务器生成一个JWT，通过加密和签名保证其完整性和安全性。
   - 服务器将生成的JWT通过响应发送回客户端。

3. **存储JWT**：
   - 客户端接收到JWT后，可以将其存储在浏览器的本地存储（local storage）或会话存储（session storage）中，也可以使用状态管理工具如Redux来管理JWT的状态。

4. **后续请求**：
   - 在客户端应用中，可以设置请求拦截器，每次发送请求时将JWT添加到请求头中。
   - 通常将JWT放在 "Authorization" 字段中：`Authorization: Bearer <token>`。
   - 服务器通过解析接收到的JWT来确认用户身份和角色，无需查询服务器端的会话存储。

通过JWT鉴权流程，服务器是无状态的，因为认证信息完全在JWT中。JWT的优点在于不需服务器存储和查询会话信息，适合分布式系统或微服务架构。
---

### 什么是单点登录（SSO）？

**SSO** 是一种用户认证机制，允许用户在多个关联系统中只登录一次，就可以访问所有关联系统，而不需要重复登录。例如：
- 登录 `toutiao.com` 后，不需要再次登录 `mp.toutiao.com`。
- 这一切通过共享认证状态来实现。

SSO 通过 `OAuth` 协议实现具体原理可以参考 [理解OAuth 2.0 --ruanyifeng](https://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html)

#### 实现 SSO 的常见方式
##### 1. **基于共享 Cookie 的 SSO（适用于同域或子域场景）**

- **原理**：
    - Cookie 是可以设置作用域的，例如 `Domain=.toutiao.com`。
    - 当一个用户登录成功时，服务器通过 `Set-Cookie` 响应头将认证信息（如 Session ID 或 Token）保存在浏览器的 Cookie 中，并将其作用域设置为主域（如 `.toutiao.com`）。
    - 所有属于 `.toutiao.com` 的子域（如 `mp.toutiao.com`、`www.toutiao.com`）都可以共享这个 Cookie。
- **示例**：
    
    http
    
    `Set-Cookie: session_id=abc123; Domain=.toutiao.com; Path=/; HttpOnly; Secure`
    
    - 这样，`session_id` 将对主域 `toutiao.com` 及其所有子域有效。
- **结果**：
    - 用户在 `toutiao.com` 登录后，浏览器会自动携带这个 Cookie 访问 `mp.toutiao.com`，从而实现无感登录。

---

##### 2. **基于 Token 的 SSO（适用于跨域场景）**

如果 SSO 涉及跨域（例如从 `example.com` 登录后访问 `another.com`），Cookie 默认无法直接共享，此时可以使用 Token 机制实现：

- 用户登录成功后，服务器生成一个 Token（如 JWT）。
- 通过 URL 或跳转将 Token 传递给目标系统。
- 目标系统验证 Token 的合法性后，创建自己的会话。