# HTTPS 协议

## 与 HTTP 的差异

- HTTPS 通过在 HTTP 与 TCP 层间加入了 TLS/SSL 层解决了一些网络传输中安全的需求，这也是 HTTPS 的最大作用
- HTTP 的连接相对简单，TCP 三次握手便可进行 HTTP 传输，而 HTTPS 需要在 TCP 三次握手后进行 TLS 的握手才能进行加密报文的传输（HTTP3 进行了整合）
- HTTP 的默认端口是 80，HTTPS 的默认端口是 443
- 外部依赖，HTTPS 需要向 CA (证书权威机构) 申请数字证书，以确保身份可信

## 解决安全问题

HTTP 属于明文传输，存在一些安全问题

- 窃听风险， 中间人可以监听通信内容
- 篡改风险，传输过程中恶意插入/篡改信息
- 冒充风险，恶意伪装网站进行信息窃取

## 实现原理

分别使用混合加密，校验机制，数字证书，解决了上述问题

### 混合加密

SSL 采取既使用非对称加密又用对称加密的方式的**混合加密方式**

- 连接建立前，采取非对称加密的方式保证信息的机密性， 防止窃听的风险
- 连接建立后，使用计算出的唯一安全密钥进行对称加密，运算速度快

非对称加密: 非对称加密的核心是双方用各自的私钥和共同的公钥协商出中间人无法监听得到的共享秘钥对数据加密

### 校验机制

HTTPS 采用 **摘要算法** + **数字签名** 的方式实现校验机制保证传输内容不被中间人篡改。

**摘要算法**实现原理： 服务端传递内容时根据发送内容计算 Hash(Hash 值无法反推内容)，然后客户端再根据收到内容计算 Hash，如果相等则可以认为无误

上述流程中存在问题： 倘若黑客直接把内容与哈希整个替换掉，，客户端便无法检查出是否有篡改，此时就用到了数字签名

**数字签名** ： 使用非对称加密对哈希值进行加密，在哈希值发送与收到校验的过程中，用到了私钥加密公钥解密的方式确保信息的身份，这个过程被称为数字签名算法

通过校验机制和数字证书就解决了 HTTP 传输数据会被中间人篡改的风险

### 数字证书

只差最后一步———当前的公钥私钥是可以被攻击人伪造的，为解决这一点，将服务端的公钥用公信机构的私钥进行加密，并用公信机构 CA 颁发的数字证书来保证公钥的可信性

数字证书的工作流程

1. 服务器把自己的公钥注册到 CA
2. CA 用自己的私钥将公钥进行数字签名并颁发数字证书
3. 在与客户端通信过程中服务端把服务器公钥与 CA 数字签名一起发给客户端
4. 客户端拿到服务器数字证书后用 CA 的公钥验证数字证书真实性
5. 从数字证书拿到服务器公钥后对报文加密，发送给服务端

通过公信机构 CA 颁发数字证书解决冒充的风险

## 连接过程

1. 客户端向服务端索要身份证书并验证服务器公钥
2. 双方协商生成 **会话秘钥**
3. 此时连接成功，双方采用会话秘钥进行通信

### SSL 握手过程

SSL/TLS 握手是一个复杂的过程，主要分为以下几个步骤：

#### 第一步：Client Hello

客户端发送 Client Hello 消息给服务器，包含：

- 支持的 SSL/TLS 版本
- 客户端生成的随机数（Client Random）
- 支持的加密套件列表
- 支持的压缩方法

#### 第二步：Server Hello

服务器响应 Server Hello 消息，包含：

- 选择的 SSL/TLS 版本
- 服务器生成的随机数（Server Random）
- 选择的加密套件
- 选择的压缩方法

#### 第三步：Certificate

服务器发送数字证书给客户端，证书包含：

- 服务器的公钥
- 证书颁发机构（CA）的数字签名
- 证书的有效期等信息

#### 第四步：Server Hello Done

服务器发送 Server Hello Done 消息，表示服务器端的握手消息发送完毕。

#### 第五步：Certificate Verify（可选）

客户端验证服务器证书的合法性：

- 验证证书是否由可信 CA 签发
- 验证证书是否在有效期内
- 验证证书域名是否匹配

#### 第六步：Client Key Exchange

客户端生成预主密钥（Pre-Master Secret），用服务器公钥加密后发送给服务器。

#### 第七步：Change Cipher Spec

双方都发送 Change Cipher Spec 消息，表示后续通信将使用协商好的密钥和加密算法。

#### 第八步：Finished

双方发送 Finished 消息，包含前面所有握手消息的哈希值，用于验证握手过程的完整性。

### 密钥生成过程

在 SSL 握手过程中，会话密钥的生成过程如下：

1. **预主密钥（Pre-Master Secret）**：客户端生成 48 字节的随机数
2. **主密钥（Master Secret）**：通过 PRF 函数，使用预主密钥、Client Random 和 Server Random 生成 48 字节的主密钥
3. **会话密钥**：从主密钥中派生出实际用于加密通信的对称密钥

```
Master Secret = PRF(Pre-Master Secret, "master secret", Client Random + Server Random)
```

## TLS 版本演进

### TLS 1.0（1999 年）

- 基于 SSL 3.0，修复了一些安全漏洞
- 支持多种加密算法

### TLS 1.1（2006 年）

- 防御 CBC 攻击
- 支持显式初始化向量

### TLS 1.2（2008 年）

- 支持更强的哈希算法（SHA-256）
- 改进的伪随机函数
- 支持认证加密模式

### TLS 1.3（2018 年）

- 简化握手过程，减少往返次数
- 移除不安全的加密算法
- 支持 0-RTT 数据传输
- 增强前向安全性

## 性能优化

### HTTPS 性能影响

- **握手延迟**：TLS 握手需要额外的往返时间
- **计算开销**：加密解密操作消耗 CPU 资源
- **证书验证**：客户端需要验证证书链

### 优化策略

#### 1. 会话复用

- **Session ID 复用**：服务器为每个会话分配唯一 ID，客户端可以复用之前的会话
- **Session Ticket**：服务器将会话信息加密后发送给客户端保存

#### 2. HTTP/2

- 多路复用减少连接数
- 头部压缩减少传输量
- 服务器推送提高效率

#### 3. OCSP Stapling

- 服务器预先获取证书状态信息
- 减少客户端的 OCSP 查询延迟

#### 4. 硬件加速

- 使用专门的加密芯片
- CPU 指令集优化（AES-NI）

## 总结

HTTPS 通过 TLS/SSL 协议为 HTTP 通信提供了安全保障，解决了明文传输的安全问题。其核心机制包括：

1. **混合加密**：结合非对称加密和对称加密的优势
2. **数字签名**：确保数据完整性和身份认证
3. **数字证书**：通过 CA 建立信任链

随着网络安全威胁的不断演进，HTTPS 也在持续发展，TLS 1.3 的推出进一步提升了安全性和性能。在实际应用中，正确的配置和管理对于发挥 HTTPS 的安全作用至关重要。
